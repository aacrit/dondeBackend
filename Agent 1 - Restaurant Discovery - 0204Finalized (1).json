{
  "name": "Agent 1 - Restaurant Discovery - 0204Finalized",
  "nodes": [
    {
      "parameters": {},
      "id": "1f76da6d-17e2-46bc-ad97-3e7f6d9cd2f3",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        0,
        0
      ]
    },
    {
      "parameters": {
        "jsCode": "// Configuration - centralized and easy to modify\nconst config = {\n  neighborhoods: [\"Pilsen\", \"Loop\", \"Wicker Park\", \"Lincoln Park\", \"West Loop\", \"River North\"],\n  cuisineTypes: [\"Mexican\", \"American\", \"Italian\", \"Asian\"],\n  resultsPerQuery:20 ,\n  chicagoCoords: { lat: 41.8781, lng: -87.6298 },\n  searchRadius: 50000,\n  apiKey: \"AIzaSyAvS1xrzTurYXbRP0uMGiPvWFSgJZ6J85k\" // TEMPORARY - replace with credential\n};\n\nreturn [{ json: config }];"
      },
      "id": "678798cd-6994-4baa-9756-22b040d50b4a",
      "name": "Configuration",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        208,
        0
      ]
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "neighborhoods",
        "returnAll": true
      },
      "id": "37867598-1ce5-4726-850a-61f81a3f2b55",
      "name": "Get Neighborhood IDs",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        400,
        0
      ],
      "credentials": {
        "supabaseApi": {
          "id": "JZitKDg2Yi5Q0fPk",
          "name": "Supabase - Donde"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Get all inputs\nconst neighborhoods = $input.all();\nconst config = $('Configuration').first().json;\n\n// Build Map for O(1) lookups\nconst neighborhoodMap = new Map(\n  neighborhoods.map(item => [item.json.name, item.json.id])\n);\n\n// Generate all search query combinations upfront\nconst searchQueries = [];\nfor (const neighborhood of config.neighborhoods) {\n  for (const cuisine of config.cuisineTypes) {\n    searchQueries.push({\n      neighborhood,\n      cuisine,\n      query: `${cuisine} restaurants in ${neighborhood}, Chicago`,\n      neighborhoodId: neighborhoodMap.get(neighborhood),\n      lat: config.chicagoCoords.lat,\n      lng: config.chicagoCoords.lng,\n      radius: config.searchRadius,\n      apiKey: config.apiKey\n    });\n  }\n}\n\nconsole.log(`Generated ${searchQueries.length} search queries`);\n\nreturn searchQueries.map(q => ({ json: q }));"
      },
      "id": "b8507171-7bf0-4527-9bf7-0be301fc7747",
      "name": "Generate All Search Queries",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        608,
        0
      ]
    },
    {
      "parameters": {
        "url": "=https://maps.googleapis.com/maps/api/place/textsearch/json",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{ $json.query }}"
            },
            {
              "name": "location",
              "value": "={{ $json.lat }},={{ $json.lng }}"
            },
            {
              "name": "radius",
              "value": "={{ $json.radius }}"
            },
            {
              "name": "key",
              "value": "={{ $json.apiKey }}"
            }
          ]
        },
        "options": {}
      },
      "id": "ad6a6d04-080b-4a79-a9c4-0ddebf4761e0",
      "name": "Google Places Search",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        800,
        0
      ]
    },
    {
      "parameters": {
        "jsCode": "// Extract and deduplicate place IDs across all searches\nconst allSearches = $input.all();\nconst config = $('Configuration').first().json;\nconst placeMap = new Map();\n\nfor (const search of allSearches) {\n  const results = search.json.results || [];\n  const limited = results.slice(0, config.resultsPerQuery);\n  \n  for (const place of limited) {\n    if (!placeMap.has(place.place_id)) {\n      placeMap.set(place.place_id, {\n        place_id: place.place_id,\n        name: place.name,\n        apiKey: config.apiKey\n      });\n    }\n  }\n}\n\nconst uniquePlaces = Array.from(placeMap.values());\nconsole.log(`Found ${uniquePlaces.length} unique restaurants`);\n\nreturn uniquePlaces.map(p => ({ json: p }));"
      },
      "id": "2d31797b-2b40-4161-8b98-fa64c52be8df",
      "name": "Extract & Deduplicate Places",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1008,
        0
      ]
    },
    {
      "parameters": {
        "jsCode": "// Prepare for bulk existence check\nconst places = $input.all();\nconst placeIds = places.map(p => p.json.place_id);\n\nconsole.log(`Checking ${placeIds.length} place IDs for existence`);\n\n// Return format that Supabase can work with\nreturn places;"
      },
      "id": "98b2709c-b2ff-4a66-bd45-8c48341c3d4a",
      "name": "Prepare for Check",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1200,
        0
      ]
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "restaurants",
        "returnAll": true
      },
      "id": "992df2ca-9eae-4eb2-aec5-8527093fc4f3",
      "name": "Get All Existing Restaurants",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        1408,
        0
      ],
      "executeOnce": true,
      "credentials": {
        "supabaseApi": {
          "id": "JZitKDg2Yi5Q0fPk",
          "name": "Supabase - Donde"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Filter to only NEW restaurants based on name+address (unique constraint)\nconst potentialPlaces = $('Prepare for Check').all();\nconst existingRestaurants = $input.all();\n\n// Create Set of existing combinations (name + address)\nconst existingCombos = new Set(\n  existingRestaurants.map(r => {\n    const name = (r.json.name || '').toLowerCase().trim();\n    const address = (r.json.address || '').toLowerCase().trim();\n    return `${name}|${address}`;\n  }).filter(Boolean)\n);\n\n// Also track existing place_ids\nconst existingPlaceIds = new Set(\n  existingRestaurants.map(r => r.json.google_place_id).filter(Boolean)\n);\n\n// Filter to only new places (not in DB by name+address OR place_id)\nconst newPlaces = potentialPlaces.filter(p => {\n  const placeId = p.json.place_id;\n  \n  // If we've seen this place_id, it's a duplicate\n  if (existingPlaceIds.has(placeId)) {\n    return false;\n  }\n  \n  // If we have name from initial search, check that too\n  if (p.json.name) {\n    const combo = `${p.json.name.toLowerCase().trim()}|`;\n    // Check if any existing combo starts with this name\n    // (We'll do full check after getting details)\n    for (const existing of existingCombos) {\n      if (existing.startsWith(combo)) {\n        return false;\n      }\n    }\n  }\n  \n  return true;\n});\n\nconsole.log(`Found ${newPlaces.length} potentially new restaurants out of ${potentialPlaces.length} total`);\nconsole.log(`Filtered out ${potentialPlaces.length - newPlaces.length} duplicates`);\n\nreturn newPlaces;"
      },
      "id": "b88a250b-5293-424c-970b-3b1f369c145c",
      "name": "Filter to New Only",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1600,
        0
      ]
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $input.all().length }}",
              "operation": "larger"
            }
          ]
        }
      },
      "id": "6e1b1049-a3e1-4bcb-8ce9-990c8f6b2f0a",
      "name": "Any New Places?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        1776,
        0
      ]
    },
    {
      "parameters": {
        "jsCode": "console.log('=== NO NEW RESTAURANTS ===');\nconsole.log('All restaurants already in database');\n\nreturn [{\n  json: {\n    status: 'complete',\n    restaurants_inserted: 0,\n    message: 'No new restaurants found'\n  }\n}];"
      },
      "id": "a548eb34-532c-4c36-a745-8943b655493a",
      "name": "No New - Exit",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1856,
        368
      ]
    },
    {
      "parameters": {
        "url": "=https://maps.googleapis.com/maps/api/place/details/json",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "place_id",
              "value": "={{ $json.place_id }}"
            },
            {
              "name": "fields",
              "value": "name,formatted_address,formatted_phone_number,website,rating,user_ratings_total,price_level,opening_hours,types,reviews,geometry,place_id"
            },
            {
              "name": "key",
              "value": "={{ $json.apiKey }}"
            }
          ]
        },
        "options": {}
      },
      "id": "0699cb42-79f6-47a6-aaf4-f418dd75dcfc",
      "name": "Get Place Details",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        2000,
        0
      ]
    },
    {
      "parameters": {
        "jsCode": "// Transform all restaurants to schema format\nconst allDetails = $input.all();\nconst queries = $('Generate All Search Queries').all();\n\n// Price level mapping\nconst priceMap = { 0: '$', 1: '$', 2: '$$', 3: '$$$', 4: '$$$$' };\n\n// Build neighborhood lookup\nconst neighborhoodLookup = new Map();\nfor (const query of queries) {\n  if (query.json.neighborhoodId) {\n    neighborhoodLookup.set(query.json.neighborhood, query.json.neighborhoodId);\n  }\n}\n\n// Chicago ZIP to Neighborhood mapping\nconst zipToNeighborhood = {\n  '60608': 'Pilsen',\n  '60601': 'Loop', '60602': 'Loop', '60603': 'Loop', '60604': 'Loop', '60605': 'Loop', '60606': 'Loop',\n  '60622': 'Wicker Park', '60647': 'Wicker Park',\n  '60614': 'Lincoln Park',\n  '60607': 'West Loop', '60661': 'West Loop',\n  '60654': 'River North', '60610': 'River North'\n};\n\nconst transformed = [];\nconst now = new Date().toISOString();\nconst debugInfo = { matched: 0, unmatched: 0, unmatchedList: [] };\n\nfor (const detail of allDetails) {\n  const result = detail.json.result || {};\n  \n  // Extract ZIP code from address\n  let neighborhoodId = null;\n  const address = result.formatted_address || '';\n  const zipMatch = address.match(/\\b(\\d{5})\\b/);\n  \n  if (zipMatch) {\n    const zip = zipMatch[1];\n    const neighborhoodName = zipToNeighborhood[zip];\n    if (neighborhoodName) {\n      neighborhoodId = neighborhoodLookup.get(neighborhoodName);\n      if (neighborhoodId) {\n        debugInfo.matched++;\n      }\n    }\n  }\n  \n  // Fallback: Try coordinates (if geometry data exists)\n  if (!neighborhoodId && result.geometry?.location) {\n    const lat = result.geometry.location.lat;\n    const lng = result.geometry.location.lng;\n    \n    const coordChecks = {\n      'Pilsen': lat >= 41.850 && lat <= 41.865 && lng >= -87.680 && lng <= -87.650,\n      'Loop': lat >= 41.875 && lat <= 41.888 && lng >= -87.635 && lng <= -87.620,\n      'Wicker Park': lat >= 41.905 && lat <= 41.915 && lng >= -87.685 && lng <= -87.665,\n      'Lincoln Park': lat >= 41.915 && lat <= 41.935 && lng >= -87.655 && lng <= -87.630,\n      'West Loop': lat >= 41.880 && lat <= 41.890 && lng >= -87.655 && lng <= -87.635,\n      'River North': lat >= 41.888 && lat <= 41.900 && lng >= -87.640 && lng <= -87.620\n    };\n    \n    for (const [name, inBounds] of Object.entries(coordChecks)) {\n      if (inBounds) {\n        neighborhoodId = neighborhoodLookup.get(name);\n        if (neighborhoodId) {\n          debugInfo.matched++;\n        }\n        break;\n      }\n    }\n  }\n  \n  // Track unmatched for debugging\n  if (!neighborhoodId) {\n    debugInfo.unmatched++;\n    if (debugInfo.unmatchedList.length < 5) {\n      debugInfo.unmatchedList.push({\n        name: result.name,\n        address: address,\n        zip: zipMatch ? zipMatch[1] : 'NO ZIP',\n        lat: result.geometry?.location?.lat,\n        lng: result.geometry?.location?.lng\n      });\n    }\n  }\n  \n  transformed.push({\n    json: {\n      name: result.name,\n      address: result.formatted_address,\n      neighborhood_id: neighborhoodId,\n      google_place_id: result.place_id,\n      google_rating: result.rating || null,\n      google_review_count: result.user_ratings_total || null,\n      price_level: priceMap[result.price_level] || '$$',\n      phone: result.formatted_phone_number || null,\n      website: result.website || null,\n      hours_of_operation: result.opening_hours || null,\n      data_source: 'google_places_api',\n      created_at: now,\n      updated_at: now\n    }\n  });\n}\n\nconsole.log(`âœ… Transformed ${transformed.length} restaurants`);\nconsole.log(`ðŸ“ Matched: ${debugInfo.matched}, Unmatched: ${debugInfo.unmatched}`);\nif (debugInfo.unmatchedList.length > 0) {\n  console.log('ðŸ” Sample unmatched:', JSON.stringify(debugInfo.unmatchedList, null, 2));\n}\n\nreturn transformed;"
      },
      "id": "b9b2d963-19aa-4b74-a8ad-07182f0e01d6",
      "name": "Bulk Transform",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2208,
        0
      ]
    },
    {
      "parameters": {
        "jsCode": "// Final deduplication check against existing DB records\n// This catches any duplicates based on name+address unique constraint\nconst transformed = $input.all();\nconst existingRestaurants = $('Get All Existing Restaurants').all();\n\n// Create Set of existing name+address combinations\nconst existingCombos = new Set(\n  existingRestaurants.map(r => {\n    const name = (r.json.name || '').toLowerCase().trim();\n    const address = (r.json.address || '').toLowerCase().trim();\n    return `${name}|||${address}`;\n  }).filter(combo => combo.length > 6) // Filter out empty entries\n);\n\n// Filter out any that match existing name+address\nconst uniqueOnly = transformed.filter(item => {\n  const name = (item.json.name || '').toLowerCase().trim();\n  const address = (item.json.address || '').toLowerCase().trim();\n  const combo = `${name}|||${address}`;\n  \n  const isDuplicate = existingCombos.has(combo);\n  if (isDuplicate) {\n    console.log(`Skipping duplicate: ${item.json.name} at ${item.json.address}`);\n  }\n  return !isDuplicate;\n});\n\nconst duplicatesFound = transformed.length - uniqueOnly.length;\n\nconsole.log(`Final check: ${uniqueOnly.length} unique restaurants to insert`);\nif (duplicatesFound > 0) {\n  console.log(`Filtered out ${duplicatesFound} duplicates based on name+address`);\n}\n\nreturn uniqueOnly;"
      },
      "id": "c025ab9d-2036-4724-9fdf-f5854c7947e4",
      "name": "Final Deduplication Check",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2400,
        0
      ]
    },
    {
      "parameters": {
        "tableId": "restaurants",
        "dataToSend": "autoMapInputData"
      },
      "id": "e034e060-9945-46de-ac43-f92960a24822",
      "name": "Bulk Insert to Supabase",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        2608,
        0
      ],
      "credentials": {
        "supabaseApi": {
          "id": "JZitKDg2Yi5Q0fPk",
          "name": "Supabase - Donde"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const inserted = $input.all();\n\nconst metrics = {\n  status: 'success',\n  restaurants_inserted: inserted.length,\n  timestamp: new Date().toISOString()\n};\n\nconsole.log('=== SUCCESS ===');\nconsole.log(`Inserted: ${metrics.restaurants_inserted} restaurants`);\n\nreturn [{ json: metrics }];"
      },
      "id": "181a2c01-3341-4831-830d-094efe6b3bfc",
      "name": "Success Logging",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2800,
        0
      ]
    }
  ],
  "pinData": {},
  "connections": {
    "Manual Trigger": {
      "main": [
        [
          {
            "node": "Configuration",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Configuration": {
      "main": [
        [
          {
            "node": "Get Neighborhood IDs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Neighborhood IDs": {
      "main": [
        [
          {
            "node": "Generate All Search Queries",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate All Search Queries": {
      "main": [
        [
          {
            "node": "Google Places Search",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Places Search": {
      "main": [
        [
          {
            "node": "Extract & Deduplicate Places",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract & Deduplicate Places": {
      "main": [
        [
          {
            "node": "Prepare for Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare for Check": {
      "main": [
        [
          {
            "node": "Get All Existing Restaurants",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get All Existing Restaurants": {
      "main": [
        [
          {
            "node": "Filter to New Only",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter to New Only": {
      "main": [
        [
          {
            "node": "Any New Places?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Any New Places?": {
      "main": [
        [
          {
            "node": "Get Place Details",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No New - Exit",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Place Details": {
      "main": [
        [
          {
            "node": "Bulk Transform",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Bulk Transform": {
      "main": [
        [
          {
            "node": "Final Deduplication Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Final Deduplication Check": {
      "main": [
        [
          {
            "node": "Bulk Insert to Supabase",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Bulk Insert to Supabase": {
      "main": [
        [
          {
            "node": "Success Logging",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "versionId": "1e787415-01d7-4018-add5-8fd97a17f9b9",
  "meta": {
    "instanceId": "3ac4b04d2be991323392602cbf815c5e6661b46c00bdd5ec1576f7ce5b92c491"
  },
  "id": "znCjfyVVLL87WvH7dGemz",
  "tags": []
}